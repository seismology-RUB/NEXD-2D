\chapter{Input}
\label{chap:input}
There are at least three different parameter files that contain all parameters necessary to run the program. If fractures are to be included in the simulation, two additional files are required. These parameter files are stored in \url{yourSimulation/data/} and are called:
\begin{itemize}
	\item parfile - general parameters
	\item source - parameters regarding the sources
	\item stations - parameters regarding the receivers
\end{itemize}  
The contents of these files will be explained in detail in subsequent sections.\\

To run the simulation, a number of other files are required that are generated by the meshing program of the users choice. These files need to be stored in the directory \url{yourSimulation/cubit/} and are called
\begin{itemize}
	\item absorb
	\item coord
	\item free
	\item mat
	\item matprop
	\item mesh
\end{itemize}
These files have a specific structure that will be explained for each file in a separate section. For the supplied examples they have been created using a python script called "cubit2dg2d.py" which uses the output from the commercial meshing software Trelis (formerly CUBIT).

If Trelis is not used, the user might have to write a script similar to "cubit2dg2d.py" that creates these files from the output of the meshing software the user uses.

	\paragraph*{General Advice}
		Prior to discussing the contents of the parameter files some general advice is given to avoid mistakes (especially related to the input format). Parameters that appear as a certain type, e.g. integer, in the parameter files will be read in in the same way. For integers that poses no issue. For floating point numbers (floats) there are a number of formatting options that will all be accepted. For example, 0.01 will be valid if entered in this way, but also if entered 1e-2. For boolean variables, either .false./.true. or F/T are valid. If any type error is detected an error message will be raised containing the affected parameter and the simulation will not run.
		
	\section{Files in \texttt{data}}
		The first section covers all parameter files that are located in \url{yourSimulation/data/}.
		
	\subsection{parfile}
	\label{subsec:parfile}
		This general parameter file contains all general parameters necessary to configure the programs. Here, all relevant features can be enabled/disabled. For convenience specific sections of the parameter file will be discussed separately.
		\subsubsection{General Parameters}
		\label{subsec:genpar}
			\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:parfile1,
    firstline = 1,
    lastline = 19,
    caption=General parameters,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/parfile.txt}
			The section of the parfile displayed in listing \ref{lis:parfile1} shows a number of general parameters. 	
			\begin{itemize}
				\item \textbf{title}: Currently "title" is just used to provide a name for the simulation in the output log files.
				\item \textbf{fluxtype}: This parameter switches between two ways to calculate the numerical fluxes. Option "0" selects the elastic fluxes calculated by \cite{moeller.2018} for the slip interface calculations. If these fluxes are selected a warning is raised, if simultaneously attenuation is set to ".true.". Option "1" selects the fluxes implemented by \citep{Lambrecht.2015}. These fluxes do not support the calculation including fractures.
				\item \textbf{log}: Set "true" if the log is to be created/displayed, "false" otherwise.
				\item \textbf{debug}: If set to "true", additional files that are helpful to do debugging are created. This currently only includes files regarding the mesh.
				\item \textbf{nproc}: Defines the number of threads (processors) used in the simulation. The value is specific to the users system configuration. Single core calculations are currently not supported, thus a minimum of 2 should be entered.
				\item \textbf{extvel}: Select if an external velocity model is to be used.
				\item \textbf{externalfilename}: Set the file name of the external velocity model. Must contain the location of the file in relation to \url{yourSimulation}, or the absolute file path. This parameter is ignored as long as "extvel" is set to "false". 
			\end{itemize}
		\subsubsection{Parameters regarding seismograms}
			This part of the parfile is displayed in listing \ref{lis:parfile2}. There are no conflicts to other parameters.
			\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:parfile2,
    firstnumber = 20,
    firstline = 20,
    lastline = 25,
    caption=Parameters regarding seismograms.,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/parfile.txt} 
    		\begin{itemize}
    			\item \textbf{autoshift}: Corrects for the "width" of the used wavelet. For a Ricker or Gaussian the maximum will be at t=0. If set to .false. plott0 is used instead.
    			\item \textbf{autodt}: Offset for the seismogram.
    			\item \textbf{div}: "true" if the radial component of the seimogram is to be calculated, otherwise "false".
    			\item \textbf{curl}: "true" if the tangential component of the seimogram is to be calculated, otherwise "false".
    		\end{itemize}
    	\subsubsection{Fracture parameters}
			This part of the parfile is displayed in listing \ref{lis:parfile3}. These parameters influence if and how the influence of fractures is created. For a detailed description on the theory behind these calculations, the interested user is referred to \cite{moeller.2018}.
			\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:parfile3,
    firstnumber = 26,
    firstline = 26,
    lastline = 30,
    caption=Parameters regarding fractures.,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/parfile.txt} 
    		\begin{itemize}
    			\item \textbf{lsi}: This parameter enables or disables the calculation of the influence of fractures. Enableling this feature requires the additional parameter files "fracs" and "interfaces". Currently this works not for calculation including attenuation.
    			\item \textbf{normal}: Enables the calculation of the fracture influence normal to the fracture plane.
    			\item \textbf{tangential}: Enables the calculation of the fracture influence parallel to the fracture plane.
    		\end{itemize}
    	\subsubsection{Movie parameters}
    	\label{subsubsec:moviepar}
			This part of the parfile is displayed in listing \ref{lis:parfile4}. These parameters influence the creation of binary files that are used by the program \url{movie} to generate "vtk"-files (Visualisation Toolkit).
			\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:parfile4,
    firstnumber = 31,
    firstline = 31,
    lastline = 39,
    caption= Movie parameters.,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/parfile.txt}
    		\begin{itemize}
    			\item \textbf{movie}: This parameter enables or disables the creation of binary files that can be used to create vtk-files.
    			\item \textbf{frame}: This parameter needs to be between 1 and the total number of time steps in the simulation. The parameter defines the number of time steps between individual snapshots for the output.
    			\item \textbf{save\_movie\_trimsh}: Create files with average values for each element. These files take significantly less space but also have a poorer resolution of the wave field.
    			\item \textbf{save\_movie\_points}: Create files with data for points in the mesh. \textit{Warning:} These files take significantly more space and slow down the simulation, but also have a much higher resolution of the wave field.
    			\item \textbf{save\_movie\_displacement}: Enable to plot the displacement field.
    			\item \textbf{save\_movie\_velocity}: Enable to plot the particle velocity field.
    			\item \textbf{save\_movie\_stress}: Enable to plot the stress field.
    		\end{itemize}
		\subsubsection{Parameters regarding time integration}
			This part of the parfile is displayed in listing \ref{lis:parfile5}. These parameters influence the selection of the method that is used for time integration, the number of time steps and the selection of the time step. 
			\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:parfile5,
    firstnumber = 40,
    firstline = 40,
    lastline = 46,
    caption= Parameters regarding time integration,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/parfile.txt} 
    	\begin{itemize}
    		\item \textbf{timeint}: This parameter selects the method for time integration. Options are:
  			\begin{enumerate}
  				\item Euler,
  				\item total variation diminishing (TVD) second order Runge-Kutta, rk2 (TVD),
  				\item third order TVD Runge-Kutta, rk3 (TVD),
  				\item low-storage five-stage fourth order Runge-Kutta, rk4 (LSERK).
  			\end{enumerate}
  			Enter the number to select the appropriate method.
  			\item \textbf{nt}: Select the number of time steps for the simulation.
  			\item \textbf{autodt}: Automatically calculate the time step based on the Courant-Friedrichs-Lewy (CFL) criterion.
  			\item \textbf{dt}: Specify dt different from the automatic one. This parameter is ignored as long as autodt is set to "true". 
  			\item \textbf{cfl}: Parameter for the CFL stability criterion. Must be 0 < cfl < 1. %Recommended values are: rk2, cfl = 0.4; rk3, cfl = ?; rk4, cfl = 0.7. 
    	\end{itemize}
		\subsubsection{Parameters regarding PML}
			This part of the parfile is displayed in listing \ref{lis:parfile6}. These parameters influence the selection of the method that is used for time integration, the number of time steps and the selection of the time step. 
			\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:parfile6,
    firstnumber = 47,
    firstline = 47,
    lastline = 56,
    caption= Parameters regarding PML,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/parfile.txt} 
    
    	\begin{itemize}
    	 	\item \textbf{set\_pml}: Enable PML as absorbing boundary condition. This parameter should only be set "true" if the mesh has been designed with a PML layer (see section \ref{chap:model} for details).
    	 	\item \textbf{pml\_delta}: This parameter describes the thickness of the PML. This parameter assumes a uniform thickness of the PML layer throughout the model. PML layers with non-uniform thickness are currently not supported.
    	 	\item \textbf{pml\_rc}: Theoretical reflection coefficient for the PML. Default is 0.01.
    	 	
    	\end{itemize}
			The parameters below influence the dampening profile of the PML. It is advised to keep the suggested values.
			
			\begin{itemize}
				\item \textbf{pml\_kmax}: Maximum value for the variable $k$. Values may range between 1 and 20.
				\item \textbf{pml\_afac}: Factor for $\alpha_{max}$.
			\end{itemize}
			
			The following parameters are not directly related to the PML layer. They serve as a control mechanism that ensures that the PML are working properly. It is designed to detect instabilities inside the PML and disables the PML, if necessary. For most cases the parameters for the length of the trigger windows can be left to the default values.
			
			\begin{itemize}
				\item \textbf{use\_trigger}: Parameter to enable the STA-LTA trigger. 
				\item \textbf{avg\_window1}: Size of the window to determine the long term average (LTA).
				\item \textbf{avg\_window2}: Size of the window to determine the short term average (STA).
				\item \textbf{sta\_lta\_trigger}: Threshold for the STA-LTA trigger. Values above this threshold will lead to disabling the PML.
			\end{itemize}
			
    	\subsubsection{Parameters regarding attenuation}
			This part of the parfile is displayed in listing \ref{lis:parfile7}. If enabled, these parameters influence the calculation of the attenuation.
			\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:parfile7,
    firstnumber = 58,
    firstline = 58,
    lastline = 62,
    caption= Parameters regarding attenuation,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/parfile.txt}
    \begin{itemize}
    	\item \textbf{attenuation}: Enable calculation of attenuation in the medium. This requires specific values to be set in the \url{yourSimulation/cubit/matprop/} file (see section \ref{subsec:matprop}).
    	\item \textbf{f0\_att}: Attenuation is simulated by a number of Maxwell bodies (see \cite{Lambrecht.2015} for details) to introduce disperion. This parameter sets the frequency to which the model parameters are assigned.
		\item \textbf{f\_max\_att}: Defines the upper end of the frequency range for the attenuation.
		\item \textbf{att\_factor}: Factor defining the lower end of frequency range for the attenuation by f\_min\_att = f\_max\_att / att\_factor.
    \end{itemize}
    
		\subsubsection{Global parameter for the stations}
			\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:parfile8,
    firstnumber = 1,
    firstline = 63,
    lastline = 65,
    caption= Receiver angle,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/parfile.txt}
    	\begin{itemize}
    	 \item \textbf{rec\_angle}: This parameter selects the angle by which \textbf{all} stations are rotated. For $0\degree$ the receiver points in the positive z-direction and the angle goes anti-clockwise, i.e., for $90\degree$ the receiver points in negative x-direction.
    	\end{itemize}
    \subsection{source}
    \label{subsec:source}
    	The example displayed in listing \ref{lis:source}, shows a typical source parameter file containing one source. 
    \lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:source,
    caption= Typical source file,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/source.txt} 
    	\begin{itemize}
    		\item \textbf{nsrc}: This parameter specifies the total number of sources in the model.
    		\item \textbf{source}: Number of the current source. If more than one source is in the file, these number must increase sequentially.
    		\item \textbf{xsource}: X-coordinate of the source. Needs to be inside the boundary of the model, but not inside the PML (if activated).
    		\item \textbf{zsource}: Z-coordinate of the source. Needs to be inside the boundary of the model, but not inside the PML (if activated).
    		\item \textbf{delay}: Parameter to specify a time-delay for the activation of the source.
    		\item \textbf{sourcetype}: Select what type of source is used. Options are: "0" for a single force solution and "1" for a moment-tensor.
    		\item \textbf{stf}: Select the source time function. Currently the following wavelets are available: "1" selects a Gaussian-function, "2" selects a Ricker-wavelet, "3" a cubed-sine function and "4" enables the user to input an arbitrary discrete external wavelet.
    		\item \textbf{extwavelet}: Path and filename of an external wavelet. Is only used if option "4" is selected for "stf".
    		\item \textbf{f0}: Sets the central frequency of the source wavelet .
    		\item \textbf{factor}: Variable to scale the amplitude of the source time function.
    		\item \textbf{angle\_force}: This parameter is used if a single force solution for the source is used. It sets the direction of the force action. For $0\degree$ the source points in the positive z-direction and the angle goes anti-clockwise, i.e., for $90\degree$ the source points in negative x-direction.
    		\item \textbf{Mxx, Mzz, Mxz}: Components of the moment-tensor, $M=\left(\begin{smallmatrix} M_{xx} & M_{xz} \\ M_{xz} & M_{zz} \end{smallmatrix}\right)$. Used only for a moment-tensor source (sourcetype = 1).
    	\end{itemize}
    	
    	If an arbitrary defined wavelet is chosen by the user, the file containing the information on the wavelet will have to be designed as follows: Two columns separated by spaces. The first column contains the time and the second column contains the amplitude of the waveform. \\
 
    	When selecting the central frequency ($f_0$) of the source(s) the user has to keep in mind that this frequency directly influences the stability of the simulation, as the maximum length of an element directly depends on $f_0$. Assuming that 10 grid points per wavelength are sufficient to achieve stability, the maximum edge length, $l$, for a given frequency is calculated according to
    	\begin{align*}
    		l = \frac{v_{min}}{\frac{10}{N} * f_{max}}\,,
		\end{align*}
		where $v_{min}$ is the slowest velocity and $N$ is the polynomial order (default is $N = 4$). $N$ can be changed in \url{src/constants.h}. Afterwards the program has to be compiled again. $f_{max}$ is the maximum frequency selected for the source(s).  	   
    \subsection{stations}
    \label{subsec:stations}
    	This example shown in listing \ref{lis:rec}, shows a typical stations parameter file containing ten stations. If not specificly desired by the user, stations should be placed in model space that is not part of the PML (if enabled).
    \lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:rec,
    caption= Typical stations file,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/stations.txt} 
    
			\begin{itemize}
				\item \textbf{nrec}: This parameter specifies the total number of stations in the model.
				\item \textbf{No xrec zrec}: The first parameter is a running number of the receiver. The other two values represent the x- and z-coordinate of the individual station.
			\end{itemize}			    		 		
    \subsection{fracs}
    \label{subsec:fracs}
    	This is the first parameter file that is added as part of the feature to calculate the influence of fractures on the wave-field. This parameter file specifies the location of one or more fractures and is used if the global parameter "lsi" is enabled. A sample file is displayed in listing \ref{lis:fracs}.
    	\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:fracs,
    caption= Parameter file defining the location of fractures,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/fracs.txt} \\
    	The first entry after "BEGIN" gives the total number of fractures to be read in. \\
    	Each fracture is defined by the following parameters (from left to right)
    	\begin{itemize}
    		\item \textbf{No}: Running number of the fracture.
    		\item \textbf{Property index}: Indicates the type of interface that creates the fracture. The interface is selected from the selection given in "interfaces". For example: If there are 4 different slip interfaces given in "interfaces" this number may be either 1, 2, 3 or 4. 
    		\item \textbf{startx, startz}: x and z coordinates of the starting point of the fracture.
    		\item \textbf{endx, endz} x and z coordinates of the end point of the fracture.
    	\end{itemize}
    \subsection{interfaces}
    \label{subsec:interfaces}
    	This is the second parameter file that is added as part of the feature to calculate the influence of fractures on the wave-field. This parameter file specifies the properties that can be selected for a fracture via the property index in the previous file. A sample file is displayed in listing \ref{lis:interface}.
    	\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:interface,
    caption= Parameter file defining fracture properties,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/interfaces.txt} \\
    	The first entry after "BEGIN" gives the total number of properties to be read in. \\
    	Each fracture property is defined by the following parameters (from left to right):
    	\begin{itemize}
    		\item \textbf{type}: currently only "elastic", viscoelastic interfaces are under development.
    		\item \textbf{thickness (h)}: The thickness of the crack is given in meters, e.g., 1\,mm requires something like 1.e-3 as input (0.001 would also work).
    		\item \textbf{Elastic modulus}: The elastic modulus is given in Pascal (Pa). Usually, values are in the order of GPa. For example, a value of 45.0\,GPa requires 45.e9 as input.
    		\item $\mathbf{C_N}$, $\mathbf{C_T}$: Dimensionless constants that are needed to calculate the relaxation frequency of the interface \citep[see][for details]{moeller.2018}.
    	\end{itemize}
    \section{Files in \texttt{cubit}}
    \label{sec:cubfiles}
    	This section explains the files related to the mesh. These files are designed in a certain way that is expected by NEXD. A script is provided that creates these files from the output of Trelis. If the user does not have Trelis or Cubit installed on his/her system and uses a different meshing software, the output of the used meshing software will have to be converted to match the requirements of NEXD.
    	\subsection{coord}
    	\label{subsec:coord}
    	\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:coord,
    caption=Excerpt from a coord file,
    breaklines=true,
    firstline = 1,
    lastline = 5,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/coord.txt}
    		This file contains a list that maps the number of a certain node in the mesh to its coordinates. The first entry is the total number of nodes in the mesh. All subsequent lines contain the running number of the nodes, the x-, and the z-coordinate. \\
    		\\
    		\fcolorbox{red}{white}{\parbox{\textwidth-2\fboxsep-2\fboxrule}{\textbf{Attention}: Note that the coordinates referred to as z-coordinates are actually the y-coordinates in the Trelis/Cubit model. This is done with regard to the convention that in seismology the depth axis is always the z-axis.}}
    	\subsection{absorb/free}
    	\label{subsec:absfree}
    		\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:absfree,
    caption=Excerpt from a absorb/free file,
    breaklines=true,
    firstline = 1,
    lastline = 5,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/absorb.txt} 
    		These two files are set up identically. These files contain the number associated with the nodes that are used to calculate the simple absorbing BC or free surface BC. The first entry in each file is the total number of nodes contained in this file. Additional lines are added sequentially for each node. An example of the first few lines from such a file is shown in listing \ref{lis:absfree}.
    	\subsection{matprop}
    	\label{subsec:matprop}
    		\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:matprop,
    caption=Entries for a matprop file,
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/matprop.txt}
    		This file lists the properties of the materials used in the model. The first entry lists the total number of materials. The subsequent lines contain the following values (from left to right):
    		\begin{itemize}
    			\item Block number (Cubit block)
    			\item Index identifying the whether the material is an elastic material or not.\footnote{Currently the value is always 1 as an elastic material is always used. This may change in future releases.}
    			\item Compressional (P-) wave velocity ($v_P$).
    			\item Shear (S-) wave velocity ($v_S$).
    			\item Density ($\rho$).
    			\item Quality factor regarding P-waves ($Q_P$).
    			\item Quality factor regarding S-waves ($Q_S$). 
    		\end{itemize}
    		The latter two values are related to anelastic calculations and influence attenuation. If attenuation is not selected in the parfile, these values will be irrelevant. If attenuation is selected and a quasi-elastic material is to be part of the simulation, these variables will need to have a high value ($Q = \infty$ for an elastic material). A sample file for an elastic medium is displayed in code listing \ref{lis:matprop}. \\

    		\fcolorbox{red}{white}{\parbox{\textwidth-2\fboxsep-2\fboxrule}{\textbf{Attention}: This file contains two materials as PML are included in the mesh. If PML are included in the simulation, they are represented by an individual material. See appendix~\ref{chap:model} for more details}}
    	\subsection{mat}
    	\label{subsec:mat}
    		\lstinputlisting[
    float=h!, 
    captionpos=b, 
    label=lis:mat,
    caption=Excerpt from the mat file,
    breaklines=true,
    firstline = 1,
    lastline = 5,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/mat.txt}
    		This file maps the material properties from the matprop file to the elements. Each line consists of the running element number, the ID of the block (in the "matprop" file) and an index to tell if the element is part of a PML. The latter index is either "0" if it is part of the regular medium or "1", if it is part of a PML. 
    	\subsection{mesh}
    	\label{subsec:mesh}
    		\lstinputlisting[
    float=ht, 
    captionpos=b, 
    label=lis:mesh,
    caption=Excerpt from the mesh file,
    breaklines=true,
    firstline = 1,
    lastline = 5,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}    
    ]{source_files/mesh.txt}
    		This file contains a mapping that relates the nodes and the material properties to the individual element. The first entry is the total number of elements in the mesh. Afterwards, each line contains the following entries (from left to right):
    		\begin{itemize}
    			\item Running number of the element
    			\item The numbers of the three nodes that are used to construct the element.
	   		\end{itemize}
	   		A few lines from a mesh file are shown in code listing \ref{lis:mesh}.
    		